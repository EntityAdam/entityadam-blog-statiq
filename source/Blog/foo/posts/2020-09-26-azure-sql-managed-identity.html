<!DOCTYPE html>
<html lang="en">

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <title>My Blog - Quick-Start: Connect ASP.NET to Azure SQL with an Azure managed identity</title>

  <link rel="canonical" href='/posts/2020-09-26-azure-sql-managed-identity'>

      <link type="application/rss+xml" rel="alternate" href="/feed.rss" />
      <link type="application/atom+xml" rel="alternate" href="/feed.atom" />

  <meta name="application-name" content='My Blog' />
  <meta name="msapplication-tooltip" content='My Blog' />
  <meta name="msapplication-starturl" content='/' />

  <meta property="og:title" content='My Blog - Quick-Start: Connect ASP.NET to Azure SQL with an Azure managed identity' />
    <meta property="og:image" content='/posts/img/adam-avatar-final-trans-400.png' />
  <meta property="og:type" content="website" />
  <meta property="og:url" content='/posts/2020-09-26-azure-sql-managed-identity' />

  <link rel="icon" href='/favicon.ico'>

  <!-- Custom fonts for this template -->
  <link href='/vendor/fontawesome-free/css/all.min.css' rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet" data-no-mirror>
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" data-no-mirror>

  <!-- Styles for this template (also includes Bootstrap) -->
  <link href='/scss/clean-blog.css' rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js" data-no-mirror></script>
  <script src="https://cdn.jsdelivr.net/npm/quicklink@2.3.0/dist/quicklink.umd.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism.css" rel="stylesheet">

  


  

</head>

<body>

  <!-- Navigation -->
  <nav class="navbar navbar-expand-lg navbar-light fixed-top" id="mainNav">
  <div class="container">
    <a class="navbar-brand" href='/'>My Blog</a>
    <button class="navbar-toggler navbar-toggler-right" type="button" data-bs-toggle="collapse" data-bs-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
      Menu
      <i class="fas fa-bars"></i>
    </button>
    <div class="collapse navbar-collapse" id="navbarResponsive">
      <ul class="navbar-nav ms-auto">
          <li class="nav-item">
    <a class="nav-link" href="/posts">Posts</a>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="/tags">Tags</a>
  </li>

      </ul>
    </div>
  </div>
</nav>


  <!-- Page Header -->
  <header class="masthead" style="background-image: url(&quot;/posts/img/adam-avatar-final-trans-400.png&quot;)">
  <div class="container position-relative">
    <div class="row">
      <div class="col-md-12">
        <div class='post-heading'>
          <h1>
            Quick-Start: Connect ASP.NET to Azure SQL with an Azure managed identity
          </h1>
            <div class="meta">Published on Saturday, September 26, 2020</div>
              <div class="mt-3">
                  <a href="/tags/c" class="badge text-bg-light"> C#</a>
                  <a href="/tags/azure" class="badge text-bg-light"> Azure</a>
                  <a href="/tags/sql" class="badge text-bg-light"> SQL</a>
                  <a href="/tags/asp.net" class="badge text-bg-light"> ASP.NET</a>
                  <a href="/tags/net" class="badge text-bg-light"> .NET</a>
                  <a href="/tags/entity-framework" class="badge text-bg-light"> Entity Framework</a>
              </div>
        </div>
      </div>
    </div>
  </div>
</header>


  <!-- Main Content -->
  <div class="container">
    <div class="row">
      <div id="content" class="col-md-12">
        <p>Connect an ASP.NET Application running on Azure Web Apps to Azure SQL and leave no messy secrets laying about in the <code>web.config</code> file, depending on Azure Key Vault, or have to orchestrate building a connection string with via Azure Resource Manager.</p>
<h1 id="the-purpose">The purpose</h1>
<p>Of course you should learn everything about managed identities, Azure SQL, Azure Active Directory and Azure Web Apps, but seriously sometimes we don't have time to do all that reading and just need a quick-start. I'm providing a summary of just enough information to get it wired up but please do check out the relevant links. And here's a <a href="https://github.com/EntityAdam/AspNetEfAzureSql/tree/master/AspNetEfAzureSql">link to the GitHub repo</a>.</p>
<h1 id="what-is-a-managed-identity">What is a managed identity?</h1>
<p>Managed identities was previously referred to as Managed Service Identity (MSI). In summary, managed identities in Azure are an Azure Active Directory feature that allows Azure resources to authenticate to any azure service that supports managed identities. If you'd like to dig deeper, Microsoft Docs provide a great <a href="https://docs.microsoft.com/en-us/azure/active-directory/managed-identities-azure-resources/overview">overview here.</a></p>
<h1 id="quick-start">Quick Start</h1>
<h2 id="overview">Overview</h2>
<ol>
<li>Provisioning Azure Resources
<ol>
<li>Resource Group</li>
<li>App Service Plan</li>
<li>App Service</li>
<li>Azure Sql Server</li>
<li>Azure Sql Database</li>
</ol>
</li>
<li>Configuring Azure Resources
<ol>
<li>Flip the App Service <code>Identity</code> on</li>
<li>Add a Sql Server Admin</li>
<li>Allow the App Service's identity to access the Azure Sql Database</li>
</ol>
</li>
<li>The ASP.NET Application
<ol>
<li>Add dependencies to the application</li>
<li>Configure the application</li>
</ol>
</li>
</ol>
<h1 id="provisioning-azure-resources">1. Provisioning Azure Resources</h1>
<p>Just a bit of Powershell to get the resources up an running. The result will be:</p>
<table>
<thead>
<tr>
<th>Resource</th>
<th>Name</th>
</tr>
</thead>
<tbody>
<tr>
<td>Resource Group</td>
<td>ISBORKED919-RG</td>
</tr>
<tr>
<td>App Service Plan</td>
<td>ISBORKED919-ASP</td>
</tr>
<tr>
<td>App Service</td>
<td>isborked919</td>
</tr>
<tr>
<td>Azure Sql Server</td>
<td>isborked919sql</td>
</tr>
<tr>
<td>Azure Sql Database</td>
<td>isborked919</td>
</tr>
</tbody>
</table>
<blockquote>
<p>These resources need to be globally unique! If you'd like to try this out on your own Azure Subscription, you may need to change <code>$app</code> variable.</p>
</blockquote>
<pre><code class="language-s"># login
az login

# variables
$app = &quot;isborked919&quot;
$location = &quot;eastus&quot;
$sqlAdminUser = $app + &quot;sqladmin&quot;
$sqlAdminPass = &quot;&lt;generate a password&gt;&quot;

# create resrouce group
$group = (az group create -l $location -n ($app.ToUpper() + &quot;-RG&quot;)|ConvertFrom-Json)

# create app service plan with the free tier
$plan = (az appservice plan create -g $group.name -l $location  -n ($app.ToUpper() + &quot;-ASP&quot;) --sku FREE|ConvertFrom-Json)

# create app service
az webapp create -g $group.name -p $plan.name -n $app.ToLower()

# create the sql server
$server = (az sql server create -l $location -g $group.name -n ($app.ToLower() + &quot;sql&quot;) -u $sqlAdminUser -p $sqlAdminPassword|ConvertFrom-Json)

# create the sql database
az sql db create -g $group.name -s $server.name -n $app
</code></pre>
<h1 id="configuring-the-azure-resources">2. Configuring the Azure Resources</h1>
<h2 id="app-service">App Service</h2>
<p>Navigate to the App Service and in the menu, we're looking for the <code>Identity</code> blade. Flip the <code>Status</code> switch to 'On', click save and accept the dialog to register the managed identity on Azure Active Directory.</p>
<p><img src="/img/posts/20200926-002-app-svc-identity-on.png" alt="alt text" title="Azure App Service Menu" /></p>
<h2 id="sql-server">Sql Server</h2>
<p>Enable Active Directory admin.  In the overview, you'll notice that the Active Directory admin is listed as not configured. Click on the <code>Not configured</code> link. Use the 'Set Admin' button to choose an existing Azure AD account that you will use as the Sql Server Admin.</p>
<p><img src="/img/posts/20200926-003-sql-server-ad-admin-not-configured.png" alt="alt text" title="Azure Sql Server Overview" /></p>
<h2 id="sql-database">Sql Database</h2>
<p>There's some instructions on how to set this up through the Azure Cloud Shell but I found it was simpler just to use Sql Server Management Studio (SSMS). We can connect to the database as the Azure Active Directory Admin by selecting the appropriate AD login method. I used <code>Azure Active Directory - Universal with MFA</code> because everyone should have MFA enabled.</p>
<blockquote>
<p>On first attempt there will be a prompt to add our client IP address to the networking configuration of the SQL Server, since by default it is less secure without additional configuration, Azure locks access down by client IP address.</p>
</blockquote>
<p>Once we're connected to Azure SQL via SSMS, we can create a user for our app. When you open a new query editor the <code>master</code> table will be selected. Switch to our database name, in this case <code>isborked919</code>. We'll issue the following command to create a user with a username that is the app service name.</p>
<pre><code class="language-sql">CREATE USER [isborked919] FROM EXTERNAL PROVIDER;
</code></pre>
<p>Now, since we're using Entity Framework and the application was scaffolded as code first, EF needs to be able to create tables so we'll simply assign the new user to the <code>db_owner</code> role.</p>
<pre><code class="language-sql">EXEC sp_addrolemember 'db_owner', 'isborked919';  
</code></pre>
<p>Now our web app's managed identity is mapped to the Azure SQL database. On to the application.</p>
<h1 id="the-application">3. The Application</h1>
<p>The application is nothing special. It's slightly less useful than a todo app. You can clone it and try it yourself, or just look at the important bits in the <code>web.config</code> file.</p>
<p>It has one model, and an associated <code>Controller</code> and an Entity Framework <code>DbContext</code></p>
<p>The key (see what I did there?) takeaway is that in the <code>web.config</code> file where the application gets the connection string from, doesn't have a password in it. When this application is running on the App Service, it will use the app service's managed identity to authenticate to Azure Sql.</p>
<pre><code class="language-xml">&lt;connectionStrings&gt;
   &lt;add name=&quot;BorkContext&quot; connectionString=&quot;Server=tcp:isborked.database.windows.net,1433;database=ISBORKED;UID=ISBORKED;Authentication=Active Directory Interactive&quot; providerName=&quot;System.Data.SqlClient&quot; /&gt;
&lt;/connectionStrings&gt;
</code></pre>
<h2 id="add-dependencies-to-the-application">Add dependencies to the application</h2>
<p>To get this to all work together, we'll need <em>something</em> that knows how to interact with Azure Active Directory.  For ASP.NET this is pretty simple because all we need is a <a href="https://www.nuget.org/packages/Microsoft.Azure.Services.AppAuthentication">Nuget package from the Azure SDK</a>.</p>
<pre><code class="language-s">Install-Package Install-Package Microsoft.Azure.Services.AppAuthentication -Version 1.5.0
</code></pre>
<p>To use this package, we'll need to add it to our <code>web.config</code>.  First we'll provide a <code>&lt;configSection&gt;</code> to let the <code>System.Data.SqlClient</code> know that we want it to use a specific authentication provider, and then plug in the assembly as a provider.</p>
<blockquote>
<p>Entity Framework uses <code>System.Data.SqlClient</code> when communicating to Sql Server, however it can be configured to use other providers like Oracle, Sql Lite, Postgres, etc.</p>
</blockquote>
<pre><code class="language-xml">&lt;configSections&gt;
   &lt;!-- Let SqlClient know that we're specifying an authentication provider --&gt;
   &lt;section name=&quot;SqlAuthenticationProviders&quot; type=&quot;System.Data.SqlClient.SqlAuthenticationProviderConfigurationSection, System.Data, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089&quot; /&gt;
&lt;/configSections&gt;

And again, plug in the `AppAuthentication` assembly in as an authentication provider
```xml
&lt;SqlAuthenticationProviders&gt;
   &lt;providers&gt;
      &lt;add name=&quot;Active Directory Interactive&quot; type=&quot;Microsoft.Azure.Services.AppAuthentication.SqlAppAuthenticationProvider, Microsoft.Azure.Services.AppAuthentication&quot; /&gt;
   &lt;/providers&gt;
&lt;/SqlAuthenticationProviders&gt;
</code></pre>
<p>Happy hacking!</p>
<p>Resources:</p>
<ul>
<li><a href="https://docs.microsoft.com/en-us/azure/azure-sql/database/authentication-aad-overview">https://docs.microsoft.com/en-us/azure/azure-sql/database/authentication-aad-overview</a></li>
<li><a href="https://docs.microsoft.com/en-us/azure/active-directory/managed-identities-azure-resources/tutorial-windows-vm-access-sql">https://docs.microsoft.com/en-us/azure/active-directory/managed-identities-azure-resources/tutorial-windows-vm-access-sql</a></li>
<li><a href="https://github.com/EntityAdam/AspNetEfAzureSql/tree/master/AspNetEfAzureSql">https://github.com/EntityAdam/AspNetEfAzureSql/tree/master/AspNetEfAzureSql</a></li>
</ul>


        

      </div>
    </div>
  </div>

  <hr>

  <!-- Footer -->
  <footer>
  <div class="container">
    <div class="row">
      <div class="col-md-12 text-center">
        <p class="copyright">Copyright &#xA9; 2023</p>

        <ul class="list-inline text-center small">
            <li class="list-inline-item">
              <a href="/feed.rss"><i class="fa fa-rss"></i> RSS Feed</a>
            </li>
            <li class="list-inline-item">
              <a href="/feed.atom"><i class="fa fa-rss"></i> Atom Feed</a>
            </li>
        </ul>
        <br />
        <div class="font-weight-bold small"><a href="https://statiq.dev">Generated by Statiq</a></div>
      </div>
    </div>
  </div>
</footer>


  <!-- Scripts -->
  <script src='/vendor/bootstrap/js/bootstrap.bundle.min.js'></script>
  <script src='/vendor/startbootstrap-clean-blog/js/scripts.js'></script>
  <script src='/js/clean-blog.js'></script>
  

  

</body>

</html>
